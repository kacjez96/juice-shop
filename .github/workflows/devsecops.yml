name: DevSecOps Pipeline (Build & Scan)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # --- ETAP 1: BUILD ---
  # Ten jeden job reprezentuje cały etap "build".
  build-docker-image:
    name: Stage 1 - Build Docker Image
    runs-on: ubuntu-latest
    # Uprawnienia do zapisu obrazu w rejestrze kontenerów GitHub
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Logowanie do GitHub Container Registry (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Budowanie obrazu z oryginalnego Dockerfile i wypchnięcie do GHCR
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Obraz będzie dostępny pod adresem: ghcr.io/TWOJA_NAZWA/NAZWA_REPO:latest
          tags: ghcr.io/${{ github.repository }}:latest

  # --- ETAP 2: SCAN ---
  # Wszystkie poniższe joby zależą od `build-docker-image` i uruchomią się równolegle.

  sca-scan:
    name: Stage 2 - SCA Scan (NPM Audit)
    runs-on: ubuntu-latest
    needs: build-docker-image # Zależy od zakończenia etapu 'build'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Używamy wersji Node.js zgodnej z oryginalnym Dockerfile (v20 jest bezpiecznym wyborem)
          node-version: '20'
      - name: Install dependencies
        run: npm install
      - name: Run NPM Audit for High/Critical issues
        run: npm audit --audit-level=high
        continue-on-error: true # Nie przerywaj pipeline'u po znalezieniu podatności

  sast-scan:
    name: Stage 2 - SAST Scan (Semgrep)
    runs-on: ubuntu-latest
    needs: build-docker-image
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep with verbose output
        run: |
          echo "🔍 Starting Semgrep SAST scan with verbose output..."
          echo "=================================================="

          # Uruchom Semgrep z verbose i kolorowym outputem
          semgrep --config=auto \
                  --verbose \
                  --no-error \
                  --force-color \
                  || true

          echo "=================================================="
          echo "🔍 Detailed scan with severity breakdown:"
          echo "=================================================="

          # Pokaż tylko HIGH i CRITICAL z większymi szczegółami
          semgrep --config=auto \
                  --severity=WARNING,ERROR \
                  --verbose \
                  --no-error \
                  --force-color \
                  || true

      - name: Run Semgrep and show summary
        run: |
          echo "=================================================="
          echo "📊 SAST Scan Summary:"
          echo "=================================================="

          # Uruchom z JSON aby policzyć, ale pokaż też w konsoli
          semgrep --config=auto --json -o /tmp/results.json || true

          if [ -f /tmp/results.json ]; then
            TOTAL=$(jq '.results | length' /tmp/results.json)
            HIGH=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' /tmp/results.json)
            CRITICAL=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' /tmp/results.json)

            echo "📈 Total findings: $TOTAL"
            echo "⚠️  High severity: $HIGH"
            echo "🚨 Critical severity: $CRITICAL"
            echo ""
            echo "🔝 Top 5 Critical Issues:"
            echo "------------------------"

            # Wyświetl top 5 krytycznych z detalami
            jq -r '.results[] | select(.extra.severity == "ERROR") | 
              "❌ \(.check_id)\n   File: \(.path):\(.start.line)\n   Message: \(.extra.message)\n   Fix: \(.extra.fix // "No automated fix available")\n"' \
              /tmp/results.json | head -20

            echo ""
            echo "⚠️  Top 5 High Issues:"
            echo "------------------------"

            jq -r '.results[] | select(.extra.severity == "WARNING") | 
              "⚠️  \(.check_id)\n   File: \(.path):\(.start.line)\n   Message: \(.extra.message)\n"' \
              /tmp/results.json | head -20
          fi

          echo "=================================================="
          echo "✅ SAST scan completed!"

  secrets-scan:
    name: Stage 2 - Secrets Scan (GitLeaks)
    runs-on: ubuntu-latest
    needs: build-docker-image
    # Job został zaktualizowany, aby używać GitLeaks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # GitLeaks potrzebuje pełnej historii do skanowania
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          # Token jest potrzebny do przesyłania wyników jako SARIF do zakładki Security
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

dast-scan:
    name: DAST Scan with Docker-in-Docker
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:20.10.16-dind
        privileged: true
        options: >-
          --privileged
          --storage-driver=overlay2
        ports:
          - 2375:2375

    env:
      DOCKER_HOST: tcp://localhost:2375

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and run Juice Shop app inside DinD
        run: |
          docker pull ghcr.io/${{ github.repository }}:latest
          docker run -d --name juice-shop -p 3000:3000 ghcr.io/${{ github.repository }}:latest

      - name: Wait for app to start
        run: sleep 30

      - name: Run OWASP ZAP Baseline Scan inside DinD
        run: |
          docker run --rm \
            -v $(pwd):/zap/wrk \
            owasp/zap2docker-stable zap-baseline.py \
            -t http://host.docker.internal:3000 \
            -w /zap/wrk/zap_report.md \
            -J /zap/wrk/zap_report.json \
            -r zap_report.html || true

      - name: Upload ZAP Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: zap_scan_report
          path: |
            zap_report.md
            zap_report.json
            zap_report.html

      - name: Stop Juice Shop container
        run: |
          docker stop juice-shop
          docker rm juice-shop
