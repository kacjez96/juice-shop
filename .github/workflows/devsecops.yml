name: DevSecOps Pipeline (Build & Scan)

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # --- ETAP 1: BUILD ---
  # Ten jeden job reprezentuje cały etap "build".
  build-docker-image:
    name: Stage 1 - Build Docker Image
    runs-on: ubuntu-latest
    # Uprawnienia do zapisu obrazu w rejestrze kontenerów GitHub
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Logowanie do GitHub Container Registry (GHCR)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Budowanie obrazu z oryginalnego Dockerfile i wypchnięcie do GHCR
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Obraz będzie dostępny pod adresem: ghcr.io/TWOJA_NAZWA/NAZWA_REPO:latest
          tags: ghcr.io/${{ github.repository }}:latest

  # --- ETAP 2: SCAN ---
  # Wszystkie poniższe joby zależą od `build-docker-image` i uruchomią się równolegle.

  sca-scan:
    name: Stage 2 - SCA Scan (NPM Audit)
    runs-on: ubuntu-latest
    needs: build-docker-image # Zależy od zakończenia etapu 'build'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Używamy wersji Node.js zgodnej z oryginalnym Dockerfile (v20 jest bezpiecznym wyborem)
          node-version: '20'
      - name: Install dependencies
        run: npm install
      - name: Run NPM Audit for High/Critical issues
        run: npm audit --audit-level=high
        continue-on-error: true # Nie przerywaj pipeline'u po znalezieniu podatności

  sast-scan:
    name: Stage 2 - SAST Scan (Semgrep)
    runs-on: ubuntu-latest
    needs: build-docker-image
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep and analyze results
        run: |
          # Uruchom skan i zapisz wyniki
          semgrep --config=auto --json --output=semgrep-results.json || true

          # Analizuj wyniki
          if [ -f semgrep-results.json ]; then
            TOTAL=$(jq '.results | length' semgrep-results.json)
            HIGH=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep-results.json)
            CRITICAL=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json)

            echo "## Semgrep Results" >> $GITHUB_STEP_SUMMARY
            echo "- Total findings: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- High severity: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- Critical severity: $CRITICAL" >> $GITHUB_STEP_SUMMARY

            # Wyświetl pierwsze 5 krytycznych
            echo "### Top Critical Issues:" >> $GITHUB_STEP_SUMMARY
            jq -r '.results[] | select(.extra.severity == "ERROR") | "\(.path):\(.start.line) - \(.extra.message)"' semgrep-results.json | head -5 >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v3
        with:
          name: semgrep-results
          path: semgrep-results.json

  secrets-scan:
    name: Stage 2 - Secrets Scan (GitLeaks)
    runs-on: ubuntu-latest
    needs: build-docker-image
    # Job został zaktualizowany, aby używać GitLeaks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # GitLeaks potrzebuje pełnej historii do skanowania
        with:
          fetch-depth: 0
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          # Token jest potrzebny do przesyłania wyników jako SARIF do zakładki Security
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dast-scan:
    name: Stage 2 - DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: build-docker-image # Zależy od zakończenia etapu 'build'
    # Uprawnienia do odczytu obrazu z rejestru kontenerów GitHub
    permissions:
      packages: read
      issues: write
      contents: read
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull and run the application container
        run: |
          echo "Pulling image from ghcr.io/${{ github.repository }}:latest"
          docker pull ghcr.io/${{ github.repository }}:latest
          echo "Starting container in background..."
          # Uruchamiamy kontener w tle (-d) i mapujemy port 3000
          docker run -d --name juice-shop -p 3000:3000 ghcr.io/${{ github.repository }}:latest

      - name: Wait for application to be ready
        run: |
          echo "Waiting 30 seconds for the application to start..."
          sleep 30
          echo "Checking if the container is running..."
          docker ps
          echo "Checking application logs..."
          docker logs juice-shop

      - name: Run ZAP Baseline Scan against the running container
        uses: zaproxy/action-baseline@v0.11.0
        with:
          # Skanujemy aplikację dostępną na localhost w środowisku runnera
          target: 'http://localhost:3000'
          fail_action: false # Nie przerywaj pipeline'u

      - name: Upload ZAP Scan Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-report
          path: zap_report.html
